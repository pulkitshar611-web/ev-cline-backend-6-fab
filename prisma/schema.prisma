generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model appointment {
  id          Int      @id @default(autoincrement())
  clinicId    Int
  patientId   Int
  doctorId    Int
  date        DateTime
  time        String
  status      String   @default("Pending")
  queueStatus String   @default("Pending") // Pending, Checked-In, In-Consultation, Completed, Pending-Payment, Paid
  tokenNumber Int?
  isPaid      Boolean  @default(false)
  billingAmount Decimal? @db.Decimal(10, 2)
  source      String   @default("Walk-in")
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  referenceId String?  @unique(map: "Appointment_referenceId_key")
  service     String?
  clinic      clinic   @relation(fields: [clinicId], references: [id], map: "Appointment_clinicId_fkey")
  patient     patient  @relation(fields: [patientId], references: [id], map: "Appointment_patientId_fkey")

  @@index([clinicId], map: "Appointment_clinicId_fkey")
  @@index([patientId], map: "Appointment_patientId_fkey")
}

model auditlog {
  id          Int      @id @default(autoincrement())
  action      String
  performedBy String
  userId      Int?
  clinicId    Int?
  timestamp   DateTime @default(now())
  ipAddress   String?
  device      String?
  details     String?  @db.LongText
  clinic      clinic?  @relation(fields: [clinicId], references: [id], map: "AuditLog_clinicId_fkey")
  user        user?    @relation(fields: [userId], references: [id], map: "AuditLog_userId_fkey")

  @@index([clinicId], map: "AuditLog_clinicId_fkey")
  @@index([userId], map: "AuditLog_userId_fkey")
}

model clinic {
  id                   Int                    @id @default(autoincrement())
  name                 String
  subdomain            String                 @unique(map: "Clinic_subdomain_key")
  location             String
  contact              String
  email                String
  logo                 String?
  brandingColor        String?                @default("#2D3BAE")
  status               String                 @default("active")
  modules              String?                @db.LongText
  createdDate          DateTime               @default(now())
  updatedAt            DateTime               @default(now()) @updatedAt
  bookingConfig        String?                @db.LongText
  currency             String                 @default("USD")
  lastTokenDate        DateTime?              @default(now())
  lastTokenNumber      Int                    @default(0)
  isActive             Boolean                @default(true)
  subscriptionEnd      DateTime?
  subscriptionPlan     String                 @default("Monthly")
  subscriptionStart    DateTime?
  userLimit            Int                    @default(5)
  appointment          appointment[]
  auditlog             auditlog[]
  clinicstaff          clinicstaff[]
  department           department[]
  formresponse         formresponse[]
  formtemplate         formtemplate[]
  inventory            inventory[]
  invoice              invoice[]
  medicalrecord        medicalrecord[]
  notification         notification[]
  patient              patient[]
  service_order        service_order[]
  staff_document       staff_document[]
  patient_document     patient_document[]
  subscriptionInvoices subscription_invoice[]
}

model clinicstaff {
  id             Int              @id @default(autoincrement())
  userId         Int
  clinicId       Int
  role           clinicstaff_role @default(RECEPTIONIST)
  createdAt      DateTime         @default(now())
  department     String?
  specialty      String?
  roles          String?          @db.LongText
  clinic         clinic           @relation(fields: [clinicId], references: [id], map: "ClinicStaff_clinicId_fkey")
  user           user             @relation(fields: [userId], references: [id], map: "ClinicStaff_userId_fkey")
  staff_document staff_document[]

  @@unique([userId, clinicId], map: "ClinicStaff_userId_clinicId_key")
  @@index([clinicId], map: "ClinicStaff_clinicId_idx")
  @@index([userId], map: "ClinicStaff_userId_idx")
}

model department {
  id        Int      @id @default(autoincrement())
  clinicId  Int
  name      String
  type      String   @default("CLINICAL")
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  clinic    clinic   @relation(fields: [clinicId], references: [id], map: "Department_clinicId_fkey")

  @@unique([clinicId, name], map: "Department_clinicId_name_key")
}

model formtemplate {
  id            Int             @id @default(autoincrement())
  clinicId      Int?
  name          String
  specialty     String
  status        String          @default("published")
  version       Int             @default(1)
  fields        String          @db.LongText
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt
  formresponse  formresponse[]
  clinic        clinic?         @relation(fields: [clinicId], references: [id], map: "FormTemplate_clinicId_fkey")
  medicalrecord medicalrecord[]

  @@index([clinicId], map: "FormTemplate_clinicId_fkey")
}

model invoice {
  id        String   @id
  clinicId  Int
  patientId Int
  doctorId  Int?
  service   String
  amount    Decimal  @db.Decimal(10, 2)
  status    String   @default("Pending")
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  clinic    clinic   @relation(fields: [clinicId], references: [id], map: "Invoice_clinicId_fkey")
  patient   patient  @relation(fields: [patientId], references: [id], map: "Invoice_patientId_fkey")

  @@index([clinicId], map: "Invoice_clinicId_fkey")
  @@index([patientId], map: "Invoice_patientId_fkey")
}

model medicalrecord {
  id           Int           @id @default(autoincrement())
  clinicId     Int
  patientId    Int
  doctorId     Int
  templateId   Int?
  visitDate    DateTime      @default(now())
  type         String        // ASSESSMENT, PRESCRIPTION, NOTE
  data         String        @db.LongText
  status       String        @default("Active") // For prescriptions: Pending, Ready, Dispensed
  isClosed     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @default(now()) @updatedAt
  clinic       clinic        @relation(fields: [clinicId], references: [id], map: "MedicalRecord_clinicId_fkey")
  patient      patient       @relation(fields: [patientId], references: [id], map: "MedicalRecord_patientId_fkey")
  formtemplate formtemplate? @relation(fields: [templateId], references: [id], map: "MedicalRecord_templateId_fkey")

  @@index([clinicId], map: "MedicalRecord_clinicId_fkey")
  @@index([patientId], map: "MedicalRecord_patientId_fkey")
  @@index([templateId], map: "MedicalRecord_templateId_fkey")
}

model staff_document {
  id        Int         @id @default(autoincrement())
  clinicId  Int
  staffId   Int
  type      String
  data      String      @db.LongText
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt
  clinic    clinic      @relation(fields: [clinicId], references: [id], map: "StaffDocument_clinicId_fkey")
  staff     clinicstaff @relation(fields: [staffId], references: [id], map: "StaffDocument_staffId_fkey")

  @@index([clinicId], map: "StaffDocument_clinicId_fkey")
  @@index([staffId], map: "StaffDocument_staffId_fkey")
}

model formresponse {
  id           Int          @id @default(autoincrement())
  clinicId     Int
  formId       Int
  patientId    Int
  doctorId     Int
  answers      String       @db.LongText
  submittedAt  DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt
  clinic       clinic       @relation(fields: [clinicId], references: [id])
  formtemplate formtemplate @relation(fields: [formId], references: [id])
  patient      patient      @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([formId])
  @@index([patientId])
  @@index([doctorId])
}

model notification {
  id         Int      @id @default(autoincrement())
  clinicId   Int
  department String
  message    String   @db.LongText
  status     String   @default("unread")
  createdAt  DateTime @default(now())
  clinic     clinic   @relation(fields: [clinicId], references: [id], map: "Notification_clinicId_fkey")

  @@index([clinicId], map: "Notification_clinicId_fkey")
}

model patient {
  id                    Int             @id @default(autoincrement())
  clinicId              Int
  mrn                   String?
  name                  String
  age                   Int?
  email                 String?
  phone                 String
  gender                String?
  address               String?         @db.Text
  medicalHistory        String?         @db.Text
  allergies             String?         @db.Text
  emergencyContactName  String?
  emergencyContactPhone String?
  status                String          @default("Active")
  createdYear           Int?
  lastVisit             DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @default(now()) @updatedAt
  appointment           appointment[]
  formresponse          formresponse[]
  invoice               invoice[]
  medicalrecord         medicalrecord[]
  clinic                clinic          @relation(fields: [clinicId], references: [id], map: "Patient_clinicId_fkey")
  service_order         service_order[]
  patient_document      patient_document[]

  @@unique([clinicId, mrn], map: "Patient_clinicId_mrn_key")
}

model inventory {
  id         Int       @id @default(autoincrement())
  clinicId   Int
  name       String
  sku        String?
  quantity   Int       @default(0)
  unitPrice  Decimal   @db.Decimal(10, 2)
  expiryDate DateTime?
  updatedAt  DateTime  @default(now()) @updatedAt
  clinic     clinic    @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
}

model service_order {
  id        Int      @id @default(autoincrement())
  clinicId  Int
  patientId Int
  doctorId  Int
  type      String
  testName  String
  paymentStatus String   @default("Pending") // Pending, Paid
  testStatus    String   @default("Pending") // Pending, Sample Collected, Result Uploaded, Published
  result    String?  @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  clinic    clinic   @relation(fields: [clinicId], references: [id])
  patient   patient  @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
}

model user {
  id                  Int           @id @default(autoincrement())
  email               String        @unique(map: "User_email_key")
  password            String
  name                String
  status              String        @default("active")
  joined              DateTime      @default(now())
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @default(now()) @updatedAt
  failedLoginAttempts Int           @default(0)
  lockoutUntil        DateTime?
  role                user_role     @default(RECEPTIONIST)
  phone               String?
  otp                 String?
  otpExpiry           DateTime?
  auditlog            auditlog[]
  clinicstaff         clinicstaff[]
}

model subscription_invoice {
  id            Int       @id @default(autoincrement())
  clinicId      Int
  invoiceNumber String    @unique
  amount        Decimal   @db.Decimal(10, 2)
  status        String    @default("Unpaid")
  issuedDate    DateTime  @default(now())
  dueDate       DateTime
  paidDate      DateTime?
  description   String?
  clinic        clinic    @relation(fields: [clinicId], references: [id])

  @@index([clinicId])
}

model system_settings {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.LongText
  description String?
  updatedAt   DateTime @default(now()) @updatedAt
}

enum clinicstaff_role {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  RECEPTIONIST
  PHARMACY
  LAB
  RADIOLOGY
  ACCOUNTANT
  PATIENT
  DOCUMENT_CONTROLLER
}

enum user_role {
  SUPER_ADMIN
  ADMIN
  DOCTOR
  RECEPTIONIST
  PHARMACY
  LAB
  RADIOLOGY
  ACCOUNTANT
  PATIENT
  DOCUMENT_CONTROLLER
}

model patient_document {
  id        Int      @id @default(autoincrement())
  clinicId  Int
  patientId Int
  type      String   @default("OTHER") // PASSPORT, ID_CARD, REPORT, OTHER
  name      String
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  clinic    clinic   @relation(fields: [clinicId], references: [id])
  patient   patient  @relation(fields: [patientId], references: [id])

  @@index([clinicId])
  @@index([patientId])
}
